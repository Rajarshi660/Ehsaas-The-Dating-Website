<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Explore Vibes | Ehsaas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        /* Swipe Animations */
        .swipe-right { transform: translateX(200%) rotate(30deg) !important; opacity: 0; transition: 0.7s ease-out; }
        .swipe-left { transform: translateX(-200%) rotate(-30deg) !important; opacity: 0; transition: 0.7s ease-out; }
        .match-card { transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.5s; }
    </style>
</head>
<body class="bg-[#050505] text-white antialiased no-scrollbar">

    <%- include('partials/explore-navbar') %>

    <main class="max-w-lg mx-auto px-6 py-10">
        <% if (matches && matches.length > 0) { %>
            <div class="relative h-[75vh] w-full">
                <% matches.forEach((match, index) => { %>
                    <div id="card-<%= match._id %>" 
                         class="match-card absolute inset-0 w-full h-full rounded-[3rem] overflow-hidden shadow-2xl border border-white/10"
                         style="z-index: <%= matches.length - index %>; transform: scale(<%= 1 - (index * 0.05) %>) translateY(<%= index * 15 %>px);">
                        
                        <img src="<%= match.profilePic %>" class="w-full h-full object-cover">

                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent flex flex-col justify-end p-8">
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-3xl font-black tracking-tighter"><%= match.name %></h2>
                                <span class="bg-rose-500/20 text-rose-500 text-[10px] px-2 py-1 rounded-full font-bold border border-rose-500/30">
                                    <%= match.percent %>% Sync
                                </span>
                            </div>
                            <p class="text-gray-300 text-sm mb-8 italic">"<%= match.bio || 'Seeking a frequency match.' %>"</p>

                            <div class="flex items-center justify-center gap-8 mb-4">
                                <button onclick="handleVibe('<%= match._id %>', 'cross')" class="w-16 h-16 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-rose-500 hover:bg-rose-500 hover:text-white transition-all shadow-xl group">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>

                                <button onclick="handleVibe('<%= match._id %>', 'tick')" class="w-20 h-20 rounded-full bg-rose-500 flex items-center justify-center text-white hover:scale-110 active:scale-90 transition-all shadow-2xl shadow-rose-500/40 group">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="h-[60vh] flex flex-col items-center justify-center text-center px-10">
                <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-6">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="1.5"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <h2 class="text-lg font-black uppercase tracking-widest mb-2">Aura Depleted</h2>
                <p class="text-gray-500 text-xs">No signals found in your current radius.</p>
                <a href="/profile" class="mt-8 px-6 py-2 bg-white text-black text-[10px] font-black uppercase rounded-full">Recalibrate</a>
            </div>
        <% } %>
    </main>

    <script>
        async function handleVibe(userId, action) {
            const card = document.getElementById(`card-${userId}`);
            
            try {
                const response = await fetch('/api/vibe-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ toUserId: userId, action: action })
                });

                const data = await response.json();

                if (data.success) {
                    // Trigger Swipe Animation
                    if (action === 'tick') {
                        card.classList.add('swipe-right');
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#f43f5e', '#ffffff']
                        });
                    } else {
                        card.classList.add('swipe-left');
                    }

                    // Reload page to show next card after animation
                    setTimeout(() => {
                        window.location.reload();
                    }, 600);
                }
            } catch (err) {
                console.error("Vibe Error:", err);
            }
        }
    </script>
</body>
</html>