<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= user.name %> | Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .fit-box { width: 100%; height: 100%; object-fit: cover; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { border-top: 2px solid white; color: white; opacity: 1; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .aura-minimal { background: radial-gradient(circle at top, #1a1a1a, #000); }
    </style>
</head>
<body class="aura-<%= locals.topVibe || 'minimal' %> bg-[#050505] text-white antialiased min-h-screen no-scrollbar">

    <%- include('partials/navbar') %>

    <main class="max-w-4xl mx-auto pt-10 px-4 pb-20 relative z-10">
        <header class="flex flex-col md:flex-row items-center gap-10 mb-12">
            <div class="p-1 rounded-full border-2 border-rose-500 relative cursor-pointer group" onclick="confetti()">
                <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-black overflow-hidden">
                    <img src="<%= user.profilePic || 'https://via.placeholder.com/150' %>" class="fit-box group-hover:scale-110 transition-transform duration-500">
                </div>
                <div class="absolute -bottom-2 right-6 bg-amber-500 text-black px-3 py-1 rounded-full text-[10px] font-black uppercase shadow-xl">
                    LVL <%= user.level || 1 %>
                </div>
            </div>

            <div class="flex-1 text-center md:text-left">
                <div class="flex flex-wrap items-center gap-4 mb-4 justify-center md:justify-start">
                    <h2 class="text-3xl font-black tracking-tight"><%= user.name %></h2>
                    <% if (isOwner) { %>
                        <button onclick="openModal('editModal')" class="bg-white/10 px-5 py-2 rounded-xl text-xs font-bold hover:bg-white hover:text-black transition-all">Edit Profile</button>
                    <% } %>
                </div>

                <div class="glass-card rounded-2xl p-4 flex items-center justify-between mb-6 max-w-sm mx-auto md:mx-0">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl"><%= user.moodIcon || '‚ú®' %></span>
                        <div>
                            <p class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">Current Mood</p>
                            <p class="text-sm italic font-medium"><%= user.currentMood || "Vibing..." %></p>
                        </div>
                    </div>
                    <% if (isOwner) { %>
                        <button onclick="openModal('moodModal')" class="text-rose-500 text-[10px] font-black uppercase hover:text-white transition">Change</button>
                    <% } %>
                </div>
                <p class="text-gray-400 text-sm leading-relaxed max-w-md"><%= user.bio %></p>
            </div>
        </header>

        <div class="flex justify-center border-t border-white/5 mb-8">
            <button onclick="switchTab('posts')" id="btn-posts" class="py-4 px-10 text-[10px] font-black uppercase tracking-widest active-tab">Posts</button>
            <button onclick="switchTab('reels')" id="btn-reels" class="py-4 px-10 text-gray-500 text-[10px] font-black uppercase tracking-widest">Reels</button>
        </div>

        <div id="section-posts" class="grid grid-cols-3 gap-1 md:gap-4">
            <% posts.filter(p => p.type === 'image').forEach(post => { %>
                <div class="relative group aspect-square rounded-xl overflow-hidden bg-white/5">
                    <img src="<%= post.contentUrl %>" class="fit-box">
                    <% if (isOwner) { %>
                        <button onclick="deletePost('<%= post._id %>')" class="absolute top-3 right-3 p-2 bg-black/60 backdrop-blur-md rounded-full text-rose-500 opacity-0 group-hover:opacity-100 transition-all hover:bg-rose-500 hover:text-white">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    <% } %>
                </div>
            <% }) %>
        </div>

        <div id="section-reels" class="hidden grid grid-cols-3 gap-1 md:gap-4">
            <% posts.filter(p => p.type === 'video').forEach(reel => { %>
                <div class="relative group aspect-[9/16] rounded-2xl overflow-hidden bg-black">
                    <video src="<%= reel.contentUrl %>" class="fit-box" loop muted onmouseover="this.play()" onmouseout="this.pause()"></video>
                    <% if (isOwner) { %>
                        <button onclick="deletePost('<%= reel._id %>')" class="absolute top-3 right-3 p-2 bg-black/60 backdrop-blur-md rounded-full text-rose-500 opacity-0 group-hover:opacity-100 transition-all z-20 hover:bg-rose-500 hover:text-white">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    <% } %>
                </div>
            <% }) %>
        </div>
    </main>

    <%- include('partials/modals') %>

    <div id="editModal" class="fixed inset-0 bg-black/90 z-[110] hidden items-center justify-center p-4">
        <div class="bg-[#0f0f0f] p-8 rounded-[2rem] border border-white/10 w-full max-w-sm shadow-2xl">
            <h3 class="text-center font-black text-[10px] uppercase tracking-widest text-gray-500 mb-8">Edit Identity</h3>
            <form id="edit-form" class="space-y-5">
                <input type="file" name="profilePic" class="w-full text-[10px] text-gray-500 file:bg-white/5 file:border-none file:text-white file:px-4 file:py-2 file:rounded-lg">
                <input type="text" name="name" value="<%= user.name %>" class="w-full bg-white/5 p-4 rounded-2xl border border-white/5 outline-none focus:border-rose-500 transition text-sm">
                <textarea name="bio" class="w-full bg-white/5 p-4 rounded-2xl border border-white/5 outline-none focus:border-rose-500 transition text-sm h-28"><%= user.bio %></textarea>
                <input type="text" name="genres" value="<%= user.genres.join(', ') %>" class="w-full bg-white/5 p-4 rounded-2xl border border-white/5 outline-none focus:border-rose-500 transition text-sm">
                
                <button type="button" id="save-profile-btn" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-rose-500 hover:text-white transition-all shadow-lg">
                    Save Changes
                </button>
                <button type="button" onclick="closeModal('editModal')" class="w-full mt-2 text-gray-600 font-bold text-[10px] uppercase">Cancel</button>
            </form>
        </div>
    </div>

    <div id="moodModal" class="fixed inset-0 bg-black/95 z-[110] hidden items-center justify-center p-4">
        <div class="bg-[#0f0f0f] p-8 rounded-[2rem] text-center border border-white/10 shadow-2xl">
            <h3 class="font-black text-[10px] uppercase text-gray-500 mb-8 tracking-widest">Select Aura</h3>
            <div class="grid grid-cols-4 gap-4 mb-8">
                <button onclick="setMood('üéß', 'Lo-fi Beats')" class="p-4 bg-white/5 rounded-2xl hover:bg-rose-500 hover:scale-110 transition-all text-2xl">üéß</button>
                <button onclick="setMood('‚òï', 'Coffee Craving')" class="p-4 bg-white/5 rounded-2xl hover:bg-rose-500 hover:scale-110 transition-all text-2xl">‚òï</button>
                <button onclick="setMood('üéÆ', 'Gaming Mode')" class="p-4 bg-white/5 rounded-2xl hover:bg-rose-500 hover:scale-110 transition-all text-2xl">üéÆ</button>
                <button onclick="setMood('üçï', 'Pizza Hunter')" class="p-4 bg-white/5 rounded-2xl hover:bg-rose-500 hover:scale-110 transition-all text-2xl">üçï</button>
            </div>
            <button onclick="closeModal('moodModal')" class="text-gray-600 font-bold uppercase text-[10px] tracking-widest">Cancel</button>
        </div>
    </div>

    <script>
        function openModal(id) { document.getElementById(id)?.classList.replace('hidden', 'flex'); }
        function closeModal(id) { document.getElementById(id)?.classList.replace('flex', 'hidden'); }
        
        function switchTab(tab) {
            const p = document.getElementById('section-posts'), r = document.getElementById('section-reels');
            const bp = document.getElementById('btn-posts'), br = document.getElementById('btn-reels');
            if(tab === 'posts'){ 
                p.classList.remove('hidden'); r.classList.add('hidden'); 
                bp.classList.add('active-tab'); br.classList.remove('active-tab'); 
                br.classList.add('text-gray-500'); 
            } else { 
                r.classList.remove('hidden'); p.classList.add('hidden'); 
                br.classList.add('active-tab'); bp.classList.remove('active-tab'); 
                bp.classList.add('text-gray-500'); 
            }
        }

        async function setMood(icon, mood) {
            await fetch('/api/update-mood', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ icon, mood }) });
            window.location.reload();
        }

        async function deletePost(id) {
            if(!confirm("Erase vibe?")) return;
            const res = await fetch(`/delete-post/${id}`, { method: 'POST' });
            if(res.ok) window.location.reload();
        }

        document.getElementById('save-profile-btn')?.addEventListener('click', async (e) => {
            const btn = e.target;
            btn.innerText = "Saving...";
            btn.disabled = true;
            const res = await fetch('/profile/edit', { method: 'POST', body: new FormData(document.getElementById('edit-form')) });
            if(res.ok) window.location.reload();
            else { alert("Save failed."); btn.innerText = "Save Changes"; btn.disabled = false; }
        });
    </script>
</body>
</html>