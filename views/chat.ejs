<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with <%= receiver.name %> | Ehsaas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); }
        .mic-active { color: #f43f5e; filter: drop-shadow(0 0 8px rgba(244, 63, 94, 0.6)); }
    </style>
</head>
<body class="bg-[#050505] text-white antialiased h-screen flex flex-col no-scrollbar">

    <header class="p-6 border-b border-white/10 flex items-center justify-between glass sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <a href="/explore" class="text-gray-400 hover:text-white transition">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </a>
            
            <a href="/user/<%= receiver._id %>" class="flex items-center gap-4 group">
                <div class="relative">
                    <img src="<%= receiver.profilePic %>" class="w-10 h-10 rounded-full object-cover border border-white/20 group-hover:border-rose-500 transition-all">
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-[#050505] rounded-full"></span>
                </div>
                <div>
                    <h2 class="font-bold text-sm tracking-tight group-hover:text-rose-500 transition"><%= receiver.name %></h2>
                    <p class="text-[9px] uppercase tracking-widest text-emerald-500 font-black">View Aura</p>
                </div>
            </a>
        </div>

        <button id="tts-toggle" class="p-2 rounded-xl bg-white/5 border border-white/10 text-[10px] font-black uppercase tracking-widest hover:bg-rose-500/10 transition-all flex items-center gap-2">
            <span id="tts-status-dot" class="w-2 h-2 bg-gray-500 rounded-full"></span>
            Voice Mode
        </button>
    </header>

    <main id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 no-scrollbar">
        <% chatHistory.forEach(msg => { %>
            <div class="flex <%= msg.sender.toString() === currentUser._id.toString() ? 'justify-end' : 'justify-start' %>">
                <div class="max-w-[75%] p-4 rounded-[1.5rem] <%= msg.sender.toString() === currentUser._id.toString() ? 'bg-rose-500 text-white rounded-tr-none shadow-lg shadow-rose-500/20' : 'bg-white/5 border border-white/10 rounded-tl-none' %>">
                    <p class="text-sm leading-relaxed"><%= msg.text %></p>
                </div>
            </div>
        <% }) %>
    </main>

    <footer class="p-6 glass border-t border-white/10">
        <form id="chat-form" class="max-w-4xl mx-auto flex items-center gap-3 relative">
            <div class="flex-1 flex items-center gap-3 bg-white/5 p-2 px-6 rounded-[2rem] border border-white/5 focus-within:border-rose-500/50 transition-all">
                
                <input type="text" id="msg-input" placeholder="Type or speak a vibe..." autocomplete="off" class="flex-1 bg-transparent py-3 outline-none text-sm">
                
                <button type="button" id="voice-btn" class="p-2 text-gray-500 hover:text-rose-500 transition-all">
                    <svg id="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
            </div>

            <button type="submit" class="bg-rose-500 w-12 h-12 rounded-full flex items-center justify-center text-white shadow-xl shadow-rose-500/30 hover:scale-110 active:scale-95 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </form>
    </footer>

    <script>
        const socket = io();
        const form = document.getElementById('chat-form');
        const input = document.getElementById('msg-input');
        const chatWindow = document.getElementById('chat-window');
        const voiceBtn = document.getElementById('voice-btn');
        const micIcon = document.getElementById('mic-icon');
        const ttsToggle = document.getElementById('tts-toggle');
        const ttsStatusDot = document.getElementById('tts-status-dot');

        let isVoiceModeOn = false;
        const room = "<%= room %>";
        const senderId = "<%= currentUser._id %>";

        socket.emit('joinRoom', room);

        const scrollToBottom = () => { chatWindow.scrollTop = chatWindow.scrollHeight; };
        scrollToBottom();

        // Send Message
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value.trim()) {
                socket.emit('chatMessage', { room, senderId, msg: input.value });
                input.value = '';
            }
        });

        // Receive Message
        socket.on('message', (data) => {
            const div = document.createElement('div');
            div.className = `flex ${data.senderId === senderId ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[75%] p-4 rounded-[1.5rem] ${data.senderId === senderId ? 'bg-rose-500 text-white rounded-tr-none' : 'bg-white/5 border border-white/10 rounded-tl-none'}">
                    <p class="text-sm">${data.msg}</p>
                </div>
            `;
            chatWindow.appendChild(div);
            scrollToBottom();

            // TEXT-TO-SPEECH (Reading incoming messages)
            if(isVoiceModeOn && data.senderId !== senderId) {
                const speech = new SpeechSynthesisUtterance(data.msg);
                speech.rate = 1.0;
                speech.pitch = 1.1;
                window.speechSynthesis.speak(speech);
            }
        });

        // SPEECH-TO-TEXT LOGIC
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            
            voiceBtn.addEventListener('click', () => {
                recognition.start();
                micIcon.classList.add('mic-active', 'animate-pulse');
            });

            recognition.onresult = (event) => {
                input.value = event.results[0][0].transcript;
                micIcon.classList.remove('mic-active', 'animate-pulse');
            };

            recognition.onerror = () => {
                micIcon.classList.remove('mic-active', 'animate-pulse');
            };
        } else {
            voiceBtn.style.display = 'none';
        }

        // VOICE MODE TOGGLE
        ttsToggle.addEventListener('click', () => {
            isVoiceModeOn = !isVoiceModeOn;
            ttsStatusDot.classList.toggle('bg-emerald-500', isVoiceModeOn);
            ttsStatusDot.classList.toggle('bg-gray-500', !isVoiceModeOn);
            
            if(isVoiceModeOn) {
                window.speechSynthesis.speak(new SpeechSynthesisUtterance("Voice mode active."));
            }
        });
    </script>
</body>
</html>